import streamlit as st
from fuzzywuzzy import fuzz

# ------------------------------
# 질병 데이터베이스
# ------------------------------
disease_db = {
    "개": {
        "홍역": {
            "설명": "바이러스 감염으로 여러 장기에 심각한 영향을 주는 전염병.",
            "증상": "고열, 콧물, 눈곱, 기침, 구토, 설사, 피부 발진, 경련, 마비",
            "처치": "완치가 어려워 증상 완화 및 합병증 예방 치료 필요. 예방접종이 최선."
        },
        "심장사상충": {
            "설명": "모기가 옮기는 기생충으로 심장과 폐혈관에 기생.",
            "증상": "기침, 운동량 감소, 호흡곤란, 복수",
            "처치": "주사 치료나 수술이 필요할 수 있음. 매달 예방약 복용 필수."
        },
        "파보바이러스": {
            "설명": "전염성 강한 바이러스성 장염. 강아지 치명적.",
            "증상": "심한 구토, 설사(혈변), 식욕 부진, 기력 저하, 고열, 탈수, 쇼크",
            "처치": "특효약 없음. 수액, 구토억제제, 항생제로 증상 완화. 백신 접종이 최선."
        },
        "관절염": {
            "설명": "나이 많은 개에서 흔한 질환. 관절 염증과 통증.",
            "증상": "절뚝거림, 뻣뻣한 보행, 계단 힘들어함, 활동량 감소, 통증",
            "처치": "완치는 어렵고 통증 관리, 체중 조절, 소염진통제, 관절영양제 사용."
        },
        "링웜": {
            "설명": "곰팡이 감염으로 생기는 피부병. 사람에게도 옮음.",
            "증상": "둥글게 털 빠짐, 비듬, 붉은 반점, 가려움",
            "처치": "항진균제 연고/먹는 약 + 환경 소독 필요."
        }
    },
    "고양이": {
        "백혈병 바이러스(FeLV)": {
            "설명": "침, 혈액으로 전염되는 바이러스 질환.",
            "증상": "식욕부진, 체중 감소, 빈혈, 림프절 비대, 구강염, 종양",
            "처치": "완치 불가. 면역력 유지, 증상 관리. 예방접종 가능."
        },
        "범백혈구 감소증(FPL)": {
            "설명": "일명 '고양이 파보'. 전염성 강한 바이러스성 질환.",
            "증상": "구토, 설사, 식욕 부진, 발열, 기력 상실, 치사율 높음",
            "처치": "특효약 없음. 보조적 치료(수액, 영양 공급). 예방접종이 최선."
        },
        "심장사상충": {
            "설명": "고양이도 감염되는 모기 매개 기생충.",
            "증상": "기침, 호흡곤란, 무기력, 구토",
            "처치": "치료 제한적. 예방약 복용이 최선."
        },
        "관절염": {
            "설명": "노령 고양이에서 흔한 질환. 관절 손상으로 통증 유발.",
            "증상": "절뚝거림, 점프 어려움, 활동 감소, 통증",
            "처치": "통증 관리, 체중 조절, 따뜻한 환경, 약물치료."
        },
        "링웜": {
            "설명": "곰팡이 감염으로 피부/털 손상.",
            "증상": "원형 탈모, 각질, 가려움",
            "처치": "항진균제 사용, 환경 청결 유지."
        }
    },
    "토끼": {
        "위정체(GI Stasis)": {
            "설명": "토끼 장운동이 멈추거나 느려지는 위험한 상태.",
            "증상": "식욕 부진, 대변 감소, 웅크림, 이갈이, 복부 단단함",
            "처치": "빠른 병원 진료 필요. 위장운동 촉진제, 진통제, 수액. 예방은 건초 급여."
        },
        "콕시듐증": {
            "설명": "기생충 감염으로 장에 염증.",
            "증상": "설사, 체중 감소, 탈수",
            "처치": "항콕시듐제 투여. 청결한 환경 유지."
        },
        "파스튜렐라증": {
            "설명": "세균 감염으로 호흡기 질환.",
            "증상": "재채기, 콧물, 호흡 곤란",
            "처치": "항생제 치료 필요. 스트레스 최소화."
        }
    },
    "햄스터": {
        "웻테일(Wet Tail)": {
            "설명": "햄스터 치명적인 세균성 장염.",
            "증상": "항문 주변 젖음(설사), 악취, 무기력, 식욕 부진, 탈수",
            "처치": "빠른 항생제 치료 필요. 따뜻하고 청결한 환경 유지."
        },
        "볼주머니염": {
            "설명": "볼주머니에 음식/이물질 끼어 염증.",
            "증상": "볼이 부음, 먹기 힘듦",
            "처치": "이물질 제거, 항생제 필요."
        },
        "피부진드기": {
            "설명": "진드기 감염으로 피부 문제.",
            "증상": "가려움, 털빠짐, 상처",
            "처치": "진드기 약 사용, 우리 청소 필수."
        }
    },
    "기니피그": {
        "괴혈병(Scurvy)": {
            "설명": "비타민 C 결핍으로 발생.",
            "증상": "활동량 감소, 보행 이상, 식욕 부진, 털 거침, 관절 부종",
            "처치": "비타민 C 보충. 채소나 영양제 급여."
        }
    },
    "새": {
        "호흡기 질환": {
            "설명": "세균성 감염이나 환경 문제로 발생.",
            "증상": "콧물, 재채기, 숨 가쁨, 쌕쌕거림, 기력 저하",
            "처치": "온도/습도 유지. 세균성 감염 시 항생제 필요."
        },
        "깃털뽑기": {
            "설명": "스트레스, 영양부족, 기생충, 내과질환 등 원인 다양.",
            "증상": "특정부위 깃털 빠짐, 피부 손상",
            "처치": "원인 해결. 환경 개선, 영양 보충, 스트레스 완화."
        }
    }
}

# ------------------------------
# 자연어 검색 함수
# ------------------------------
def find_disease(animal, user_symptom, top_n=2):
    results = []
    for disease, info in disease_db[animal].items():
        score = fuzz.partial_ratio(user_symptom, info["증상"])
        results.append((score, disease, info))
    results.sort(reverse=True, key=lambda x: x[0])
    return results[:top_n]

# ------------------------------
# Streamlit UI
# ------------------------------
st.title("🐾 반려동물 증상 도우미 (자연어 검색)")
st.warning("⚠️ 참고용 정보이며, 반려동물 이상 시 반드시 수의사 진료 필요")

animal = st.selectbox("동물을 선택하세요", list(disease_db.keys()))
symptom = st.text_input("증상을 자유롭게 입력하세요 (예: 설사하고 힘이 없어요, 기침 많이 함)")

if st.button("진단하기"):
    matches = find_disease(animal, symptom)
    if matches:
        for score, disease, info in matches:
            st.subheader(f"📌 예상 질병: {disease} (유사도 {score}%)")
            st.write(f"**어떤 병?** {info['설명']}")
            st.write(f"**주요 증상:** {info['증상']}")
            st.write(f"**응급 처치 방법:** {info['처치']}")
            st.markdown("---")
    else:
        st.warning("해당 증상과 일치하는 질병 데이터를 찾을 수 없습니다.")

